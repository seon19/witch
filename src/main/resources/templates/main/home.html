<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>위치 크래프트</title>
<link rel="stylesheet" th:href="@{/dist/css/all.css}" type="text/css">
<link rel="stylesheet" th:href="@{/dist/css/home.css}" type="text/css">
</head>
<body>

<div class="main-container">
	
	<div class="title-container">
		<span class="logo" th:onclick="|location.href='@{/main/home}'|">위치 크래프트</span>
		<button th:onclick="|location.href='@{/member/logout}'|">로그아웃</button>
	</div>
	
	<div class="menu-container">
		<span> MENU</span>
		<button th:onclick="|location.href='@{/notice}'|">공지사항</button>
		<button th:onclick="|location.href='@{}'|">자유게시판</button>
	</div>
	
	<div class="left-page">
	    <img th:src="@{/dist/images/바구니4.png}"
	         class="left-size"
	         th:classappend="${loginUser != null and !hasReceivedToday} ? 'pulsing-basket' : ''"
	         onclick="openDailyRewardModal()" 
	         style="cursor: pointer;">
	</div>
	
	<div class="right-page">
	    <div class="wallet-container" th:if="${loginUser != null}">
	        <span class="nickname" th:text="${loginUser.nickname}">사용자닉네임</span><span>님의 지갑</span>
	        <div class="balance-display">
	            <img th:src="@{/dist/images/coin.png}" alt="코인">
	            <span th:text="${#numbers.formatInteger(loginUser.currentBalance, 0, 'COMMA')}">1,000</span>
	        </div>
	    </div>

	    <div id="questPanel" class="quest-panel">
	      <div class="qp-title">진행중인 의뢰</div>
	      <div id="qpList" class="qp-list"></div>
	    </div>
	</div>
	
	<div class="button-container">
		<button th:onclick="|location.href='@{/work/workroom}'|">공방</button>
		<button class="spBtn2" th:onclick="|location.href='@{/recipe/recipeMain}'|">레시피북</button>
		<button class="spBtn3" th:onclick="|location.href='@{/orders/purchaseList}'|">상점</button>
		<button class="spBtn4" th:onclick="|location.href='@{/request/receive}'|">의뢰받기</button>
	</div>

</div>

<div id="dailyRewardModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeDailyRewardModal()">&times;</span>
        <div class="modal-header">
            <h2>일일 보상</h2>
        </div>
        <div class="modal-body">
            <div id="rewardContent">
                <div class="loading">보상 확인 중...</div>
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeDailyRewardModal()">확인</button>
        </div>
    </div>
</div>

<script type="text/javascript">
function openDailyRewardModal() {
  const modal = document.getElementById('dailyRewardModal');
  modal.style.display = 'flex';
  fetch('/main/dailyReward')
    .then(r => r.json())
    .then(data => {
      const rewardContent = document.getElementById('rewardContent');
      if (data.error) { rewardContent.innerHTML = `<div class="error"><p>${data.error}</p></div>`; return; }
      if (data.alreadyReceived) {
        rewardContent.innerHTML = `
          <div class="reward-already">
            <p>오늘 이미 보상을 받으셨습니다!</p>
            <div class="received-item"><span class="material-name">${data.materialName} x${data.quantity}</span></div>
            <p class="next-reward">내일 다시 방문해 주세요!</p>
          </div>`;
      } else {
        rewardContent.innerHTML = `
          <div class="reward-new">
            <p class="reward-text">축하합니다! 새로운 재료를 획득했습니다!</p>
            <div class="new-item"><span class="material-name">${data.materialName} x${data.quantity}</span></div>
            <div class="consecutive-days"><span>연속 접속: ${data.consecutiveDays}일</span></div>
          </div>`;
      }
    }).catch(err => {
      console.error(err);
      document.getElementById('rewardContent').innerHTML =
        `<div class="error"><p>보상 정보를 불러오는데 실패했습니다.</p><p>잠시 후 다시 시도해 주세요.</p></div>`;
    });
}
function closeDailyRewardModal(){ document.getElementById('dailyRewardModal').style.display = 'none'; }
window.addEventListener('click', (e) => {
  const daily = document.getElementById('dailyRewardModal');
  const reqm  = document.getElementById('reqModal');
  if (e.target === daily) daily.style.display = 'none';
  if (e.target === reqm)  reqm.classList.add('hidden');
});

let ongoing = [];
let currentRequestListId = null;

document.addEventListener('DOMContentLoaded', () => {
  loadOngoing();
  const qdBtn = document.getElementById('qdClaim');
  if (qdBtn) qdBtn.addEventListener('click', () => claim(currentRequestListId));
});

async function loadOngoing() {
  try {
    const res = await fetch('/request/api/ongoing', { headers:{Accept:'application/json'} });
    if (!res.ok) throw new Error(res.status);
    ongoing = await res.json();
    renderOngoingList();
  } catch (e) {
    console.error(e);
    ongoing = [];
    renderOngoingList();
  }
}

function renderOngoingList() {
  const box = document.getElementById('qpList');
  box.innerHTML = '';
  if (!ongoing || ongoing.length === 0) {
    box.innerHTML = `<div class="qp-item" style="opacity:.8">진행중인 의뢰가 없습니다.</div>`;
    return;
  }
  ongoing.forEach(q => {
    const li = document.createElement('div');
    li.className = 'qp-item';
    const percent = Math.min(100, q.percent || 0);
    li.innerHTML = `
      <div class="qp-top">
        <div class="qp-name" title="${escapeHtml(q.requestName || '')}"
             onclick="openDetail(${q.requestListId})">
          [Lv.${q.requestLevel}] ${escapeHtml(q.requestName || '')}
        </div>
        <div class="qp-btns">
          <button class="qp-btn" onclick="openDetail(${q.requestListId})">자세히</button>
          <button class="qp-btn" ${q.claimable ? '' : 'disabled'}
                  onclick="claim(${q.requestListId})">보상받기</button>
        </div>
      </div>
      <div class="qp-meta">${q.progressCount}/${q.progressGoal}</div>
      <div class="qp-bar"><div class="qp-fill" style="width:${percent}%"></div></div>
    `;
    box.appendChild(li);
  });
}

async function openDetail(requestListId){
  try{
    const res = await fetch(`/request/api/${requestListId}`, { headers:{Accept:'application/json'} });
    if(!res.ok) throw new Error(res.status);
    const d = await res.json();

    currentRequestListId = requestListId;

    document.getElementById('qdLevel').textContent = d.requestLevel ? `Lv.${d.requestLevel}` : '';
    document.getElementById('qdName').textContent  = d.requestName || '';
    document.getElementById('qdDesc').textContent  = d.requestContent || '';
    document.getElementById('qdClient').textContent= d.client || '';
    document.getElementById('qdExp').textContent   = d.rewardExp ?? 0;
    document.getElementById('qdGold').textContent  = d.rewardGold ?? 0;

    const itemsHtml = (d.rewardItems && d.rewardItems.length)
      ? d.rewardItems.map(i => `<span class="chip">${escapeHtml(i.materialName||'')} × ${i.qty||0}</span>`).join('')
      : '<span class="chip" style="opacity:.7">아이템 없음</span>';
    document.getElementById('qdItems').innerHTML = itemsHtml;

    const qdBtn = document.getElementById('qdClaim');
    qdBtn.disabled = !d.claimable;

    document.getElementById('qdWrap').classList.add('show');
    document.body.style.overflow = 'hidden';
  }catch(e){
    console.error(e);
    alert('의뢰 정보를 불러오지 못했습니다.');
  }
}

function closeQuestDetail(){
  document.getElementById('qdWrap').classList.remove('show');
  document.body.style.overflow = '';
}

async function claim(id){
  const target = id ?? currentRequestListId;
  if(!target) return;
  try{
    const res = await fetch(`/request/api/${target}/claim`, { method:'POST', headers:{Accept:'application/json'} });
    if(!res.ok) throw new Error(await res.text());
    await res.json();
    alert('보상을 수령했습니다!');
    closeQuestDetail();
    loadOngoing(); 
  }catch(e){
    console.error(e);
    alert('보상 수령에 실패했습니다.');
  }
}

window.addEventListener('keydown', (ev)=>{ if(ev.key === 'Escape') closeQuestDetail(); });

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

</script>

<div id="qdWrap" class="qd-wrap" aria-hidden="true">
  <div class="qd-backdrop" onclick="closeQuestDetail()"></div>
  <div class="qd-modal" role="dialog" aria-modal="true">
    <div class="qd-head">
      <div>의뢰요약</div>
      <button class="qd-x" type="button" onclick="closeQuestDetail()">×</button>
    </div>
    <div class="qd-body">
      <div class="qd-title"><span id="qdLevel"></span> <span id="qdName"></span></div>
      <div id="qdDesc" class="qd-desc"></div>
      <div class="qd-client">from. <span id="qdClient"></span></div>
      <div class="qd-reward">
        <div class="row"><strong>경험치</strong>&nbsp;<span id="qdExp">0</span></div>
        <div class="row"><strong>코인</strong>&nbsp;<span id="qdGold">0</span></div>
        <div class="row" id="qdItems"></div>
      </div>
    </div>
    <div class="qd-foot">
      <button id="qdClaim" class="qd-claim" type="button" disabled>보상받기</button>
    </div>
  </div>
</div>

</body>
</html>
