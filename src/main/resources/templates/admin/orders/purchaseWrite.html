<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>관리자 페이지</title>

<link rel="stylesheet" th:href="@{/dist/css/cssAdmin/main.css}" type="text/css">
<link rel="stylesheet" th:href="@{/dist/css/cssAdmin/materialWrite.css}" type="text/css">
<style type="text/css">
.form-buttons {
	padding-top: 20px;
}
</style>
</head>
<body>

<div class="main-container">
	<div th:replace="~{/admin/menubar :: menubarFragment}"></div>
	<div class="body-container">
		<div class="title-container">
			<span th:text="${mode=='purchaseWrite'?'구매 아이템 등록':'구매 아이템 수정'}"></span>
		</div>
		
		<div class="table-container">
			<form th:action="@{/admin/orders/{mode}(mode=${mode})}" name="purchaseForm" method="post">
				<input type="hidden" name="itemId">
				<table>
					<tr>
						<td>아이템 종류</td>
						<td>
							<label><input type="radio" name="itemType" value="material" checked> 재료</label>
							<label style="margin-left: 10px;"><input type="radio" name="itemType" value="potion"> 포션</label>
						</td>
					</tr>
					
					<tr id="material-select-row">
						<td>재료 선택</td>
						<td>
							<select name="itemId_material" id="materialSelect" class="item-select">
								<option value="">--- 재료를 선택하세요 ---</option>
								<th:block th:each="m : ${materialList}">
									<option th:value="${m.materialId}" th:text="${m.materialName}"
									    th:disabled="${registeredMaterialIds.contains(m.materialId)}"></option>
								</th:block>
							</select>
						</td>
					</tr>

					<tr id="potion-select-row" style="display: none;">
						<td>포션 선택</td>
						<td>
							<select name="itemId_potion" id="potionSelect" class="item-select">
								<option value="">--- 포션을 선택하세요 ---</option>
								<th:block th:each="p : ${potionList}">
									<option th:value="${p.potionId}" th:text="${p.potionName}"
									    th:disabled="${registeredPotionIds.contains(p.potionId)}"></option>
								</th:block>
							</select>
						</td>
					</tr>
				</table>

				<div id="item-info-area" style="display: none;">
					</div>

				<h3 style="padding: 1rem 1rem 0;">구매 정보 입력</h3>
				<table>
					 <tr>
						<td>구매 가격</td>
						<td><input type="text" name="purchasePrice" placeholder="구매 가격을 숫자로 입력하세요."></td>
					</tr>
					<tr>
						<td>구매 여부</td>
						<td>
							<label><input type="radio" name="isAvailable" value="true" checked> 구매</label>
							<label style="margin-left: 10px;"><input type="radio" name="isAvailable" value="false"> 구매 중지</label>
						</td>
					</tr>
				</table>

				<div class="form-buttons">
				    <button type="button" class="btn btn-primary" onclick="sendOk();">등록 완료</button>
				    <button type="button" class="btn btn-secondary" th:onclick="|location.href='@{/admin/orders/purchaseList}'|">등록 취소</button>
				</div>
			</form>
		</div>		
	</div>
</div>

<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    const itemTypeRadios = document.querySelectorAll('input[name="itemType"]');
    const materialRow = document.getElementById('material-select-row');
    const potionRow = document.getElementById('potion-select-row');
    const itemSelects = document.querySelectorAll('.item-select');
    const infoArea = document.getElementById('item-info-area');

    itemTypeRadios.forEach(radio => {
        radio.addEventListener('change', function(e) {
            const type = e.target.value;
            infoArea.style.display = 'none'; 
            itemSelects.forEach(sel => sel.value = ''); 

            if (type === 'material') {
                materialRow.style.display = 'table-row';
                potionRow.style.display = 'none';
            } else if (type === 'potion') {
                materialRow.style.display = 'none';
                potionRow.style.display = 'table-row';
            }
        });
    });

    itemSelects.forEach(select => {
        select.addEventListener('change', function(e) {
            const itemId = e.target.value;
            const itemType = document.querySelector('input[name="itemType"]:checked').value;

            if (!itemId) {
                infoArea.style.display = 'none';
                return;
            }

            const apiUrl = `/admin/orders/api/${itemType}/${itemId}`;

            fetch(apiUrl)
                .then(response => response.ok ? response.json() : Promise.reject('Not found'))
                .then(data => {
                    let previewHtml = '<h3>선택된 아이템 정보</h3><table>';
                    
                    if(itemType === 'material') {
                        previewHtml += `
                            <tr><td>이미지</td><td><img src="/uploads/material/${data.materialPhoto}" style="max-width:100px;"></td></tr>
                            <tr><td>이름</td><td>${data.materialName}</td></tr>
                            <tr><td>설명</td><td>${data.materialDescription}</td></tr>
                            <tr><td>기존 가격</td><td>${data.materialPrice}</td></tr>`;
                    } else if (itemType === 'potion') {
                        previewHtml += `
                            <tr><td>이미지</td><td><img src="/uploads/potion/${data.potionPhoto}" style="max-width:100px;"></td></tr>
                            <tr><td>이름</td><td>${data.potionName}</td></tr>
                            <tr><td>설명</td><td>${data.potionDescription}</td></tr>
                            <tr><td>레벨</td><td>${data.potionLevel}</td></tr>
                            <tr><td>첫번째 재료</td><td>${data.firstMaterial.materialName}</td></tr>
                            <tr><td>두번째 재료</td><td>${data.secondMaterial.materialName}</td></tr>`;
                    }

                    previewHtml += '</table>';
                    infoArea.innerHTML = previewHtml;
                    infoArea.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error:', error);
                    infoArea.style.display = 'none';
                });
        });
    });
});

function sendOk() {
    const f = document.purchaseForm;
    const itemType = f.itemType.value;
    let selectedElement;

    if (itemType === 'material') {
    	selectedElement = document.getElementById('materialSelect');
    } else {
    	selectedElement = document.getElementById('potionSelect');
    }

    if (!selectedElement.value) {
        alert('구매할 아이템을 선택해주세요.');
        selectedElement.focus();
        return;
    }
    
    f.itemId.value = selectedElement.value;
    
    const purchasePrice = f.purchasePrice.value.trim();
    const priceRegex = /^[0-9]+$/;
    if (!priceRegex.test(purchasePrice)) {
        alert('구매 가격은 숫자만 입력할 수 있습니다.');
        f.purchasePrice.focus();
        return;
    }
    
    const isAvailable = f.isAvailable.value;
    if (!isAvailable) {
        alert('구매 여부를 선택해주세요.');
        f.isAvailable.focus();
        return;
    }

    f.submit();
}
</script>

</body>
</html>