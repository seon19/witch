<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>공지사항 관리</title>
  <link rel="stylesheet" th:href="@{/dist/css/cssAdmin/main.css}" type="text/css" />
  <link rel="stylesheet" th:href="@{/dist/css/cssAdmin/noticeList.css}" type="text/css" />
</head>
<body>
<div class="main-container">
  <div th:replace="~{/admin/menubar :: menubarFragment}"></div>
  <div class="body-container">
    <header class="content-header">
      <div class="header-top">
        <div class="title-container"><span>공지사항 관리</span></div>
      </div>

      <div class="header-bottom">
        <div>
          <form method="get" th:action="@{/admin/notice/noticeList}" class="form-search" style="display:flex; gap:8px;">
		  <select name="target">
		    <option value="TITLE_CONTENT" th:selected="${target} == 'TITLE_CONTENT'">제목+내용</option>
		    <option value="AUTHOR" th:selected="${target} == 'AUTHOR'">작성자</option>
		  </select>
		
		  <input type="text" name="kwd" th:value="${kwd}">
		  <input type="hidden" name="size" th:value="${page.size}">
		  <button type="submit" class="btn-default">검색</button>
		</form>

        </div>

        <div>
          <button type="button" class="btn-default"
                  th:onclick="|location.href='@{/admin/notice/new(page=${page.number+1},size=${page.size},kwd=${kwd},visibility=${visibility})}'|">
            등록하기
          </button>
        </div>
      </div>
    </header>

    <div><span class="dataCount"></span></div>

    <div class="table-container">
      <table>
        <thead>
        <tr>
          <th>번호</th>
          <th>공지명</th>
          <th>공지내용</th>
          <th>등록일자</th>
          <th>수정일자</th>
          <th>작성자</th>
          <th>공개여부</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="n, st : ${page.content}">
          <td th:text="${#numbers.formatInteger(page.totalElements - (page.number * page.size) - st.index, 0)}"></td>
          <td>
            <a class="title-link"
               th:href="@{/admin/notice/{id}(id=${n.noticeId})}"
               th:text="${n.noticeName}">공지 제목</a>
          </td>
          <td class="ellipsis" th:text="${n.noticeContent}">내용</td>
          <td th:text="${#temporals.format(n.noticeDate, 'yyyy-MM-dd')}">-</td>
          <td th:text="${n.noticeUpdateDate != null ? #temporals.format(n.noticeUpdateDate, 'yyyy-MM-dd') : ''}"></td>

     
          <td th:text="${n.member != null && n.member.nickname != null ? n.member.nickname : ''}">작성자</td>

          <td th:text="${n.visibility == 1 ? '공개' : '비공개'}"></td>
        </tr>

        <tr th:if="${#lists.isEmpty(page.content)}" class="empty-row">
          <td colspan="7">등록된 공지사항이 없습니다.</td>
        </tr>
        </tbody>
      </table>

      <div class="table-footer">
        <div class="page-navigation-container">
          <div class="page-navigation"></div>
        </div>
        <div class="btn-refresh-container">
          <button type="button" class="btn btn-outline"
		   th:onclick="|location.href='@{/admin/notice/noticeList}'|">
		  새로고침
		  </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script th:src="@{/dist/js/paging.js}" type="text/javascript"></script>
<script type="text/javascript">
window.addEventListener('DOMContentLoaded', function () {
  const page     = (parseInt('[[${page.number}]]') || 0) + 1;   // 0-index → +1
  const pageSize = parseInt('[[${size}]]') || parseInt('[[${page.size}]]') || 10;
  const dataCount= parseInt('[[${dataCount}]]') || parseInt('[[${page.totalElements}]]') || 0;
  const total_page = parseInt('[[${page.totalPages}]]') || 1;

  let url = '[[@{/admin/notice/noticeList(target=${target}, kwd=${kwd})}]]';

  const visibilityVal = '[[${visibility}]]';
  if (visibilityVal !== '' && visibilityVal !== 'null') {
    url += (url.includes('?') ? '&' : '?') + 'visibility=' + encodeURIComponent(visibilityVal);
  }

  const paging = pagingUrl(page, total_page, url);

  document.querySelector('.dataCount').innerHTML =
    `${dataCount}개 (${page}/${total_page} 페이지)`;
  document.querySelector('.page-navigation').innerHTML =
    dataCount === 0 ? '' : paging;
});

window.addEventListener('DOMContentLoaded', () => {
  const inputEL = document.querySelector('form[name="searchForm"] input[name="kwd"]');
  if (inputEL) {
    inputEL.addEventListener('keydown', function (evt) {
      if (evt.key === 'Enter') {
        evt.preventDefault();
        searchList();
      }
    });
  }
});

function searchList() {
  const f = document.searchForm;
  const params = new URLSearchParams();
  params.set('target', f.schType ? f.schType.value : (f.target?.value || 'TITLE_CONTENT'));
  if (f.kwd && f.kwd.value.trim()) params.set('kwd', f.kwd.value.trim());

  const visibilityVal = '[[${visibility}]]';
  if (visibilityVal !== '' && visibilityVal !== 'null') {
    params.set('visibility', visibilityVal);
  }

  location.href = '[[@{/admin/notice/noticeList}]]' + '?' + params.toString();
}
</script>

</body>
</html>
